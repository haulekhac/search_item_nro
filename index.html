<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tool Search Item DragonBoy</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
[data-theme="dark"]{--bg:#0f1724;--bg1:#141e30;--bg2:#18253e;--bg3:#1d2d4a;--border:#243554;--border2:#2d4266;--text:#d4e4f7;--text2:#7a96bc;--text3:#3d5a84;--input-bg:#0a1020;--card-bg:#141e30;--shadow:rgba(0,0,0,.5);--overlay:rgba(9,15,28,.92);}
[data-theme="light"]{--bg:#f0f4fa;--bg1:#ffffff;--bg2:#f5f8fe;--bg3:#e8eef8;--border:#cbd5e8;--border2:#b0bfd8;--text:#1a2540;--text2:#4a6080;--text3:#8a9ab8;--input-bg:#f5f8fe;--card-bg:#ffffff;--shadow:rgba(0,0,0,.1);--overlay:rgba(240,244,250,.92);}
:root{--accent:#3b8bff;--accent2:#5ba3ff;--green:#22c55e;--orange:#f59e0b;--red:#ef4444;--yellow:#eab308;--purple:#8b5cf6;--cyan:#06b6d4;--mono:'JetBrains Mono',monospace;--sans:'Be Vietnam Pro',sans-serif;}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s,color .25s;}
body.has-bg{background-color:transparent !important;}
body.has-bg::before{content:'';position:fixed;inset:0;z-index:0;background:inherit;background-size:cover;background-position:center;background-attachment:fixed;pointer-events:none;}
#app,#login-screen,#loading-overlay{position:relative;z-index:1;}
body.has-bg .card,body.has-bg .topbar,body.has-bg .ic,body.has-bg .map-card{backdrop-filter:blur(2px);}
body.has-bg[data-theme="dark"] .card,body.has-bg[data-theme="dark"] .ic,body.has-bg[data-theme="dark"] .map-card{background:rgba(20,30,48,.82);}
body.has-bg[data-theme="dark"] .topbar{background:rgba(20,30,48,.92);}
body.has-bg[data-theme="light"] .card,body.has-bg[data-theme="light"] .ic,body.has-bg[data-theme="light"] .map-card{background:rgba(255,255,255,.82);}
body.has-bg[data-theme="light"] .topbar{background:rgba(255,255,255,.92);}

.theme-wrap{position:relative;display:flex;align-items:center;}
.theme-btn{width:34px;height:34px;border-radius:7px;border:1px solid var(--border);background:var(--bg2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;color:var(--text2);font-size:15px;}
.theme-btn:hover{border-color:var(--accent);color:var(--text);}
.theme-drop{position:absolute;top:calc(100% + 8px);right:0;width:310px;background:var(--bg1);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 36px rgba(0,0,0,.4);z-index:500;opacity:0;transform:translateY(-8px) scale(.97);pointer-events:none;transition:all .18s cubic-bezier(.4,0,.2,1);transform-origin:top right;padding:14px;}
.theme-drop.open{opacity:1;transform:none;pointer-events:auto;}
.theme-drop-hd{font-size:10px;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--text3);margin-bottom:10px;}
.theme-section{margin-bottom:12px;}
.theme-section-lbl{font-size:10px;font-weight:600;color:var(--text3);margin-bottom:7px;letter-spacing:.05em;text-transform:uppercase;}
.base-row{display:flex;gap:6px;margin-bottom:8px;}
.base-btn{flex:1;padding:7px 0;border-radius:7px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-family:var(--sans);font-size:11.5px;font-weight:700;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:5px;}
.base-btn:hover{border-color:var(--accent2);color:var(--text);}
.base-btn.on{border-color:var(--accent);background:rgba(59,139,255,.12);color:var(--accent2);}
.swatches{display:flex;flex-wrap:wrap;gap:6px;}
.swatch{width:34px;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .15s;flex-shrink:0;position:relative;}
.swatch:hover{transform:scale(1.1);border-color:rgba(255,255,255,.5);}
.swatch.on{border-color:#fff;box-shadow:0 0 0 2px var(--accent);}
.swatch::after{content:'✓';position:absolute;inset:0;display:none;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.5);}
.swatch.on::after{display:flex;}
.upload-area{border:1.5px dashed var(--border2);border-radius:8px;padding:10px 12px;cursor:pointer;transition:border-color .15s;display:flex;align-items:center;gap:9px;font-size:12px;color:var(--text2);font-weight:600;}
.upload-area:hover{border-color:var(--accent);color:var(--text);}
.upload-area svg{flex-shrink:0;opacity:.7;}
.upload-preview{width:100%;height:52px;object-fit:cover;border-radius:7px;margin-top:7px;border:1px solid var(--border);display:none;}
.upload-preview.show{display:block;}
.clear-bg-btn{width:100%;margin-top:6px;padding:6px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--red);font-family:var(--sans);font-size:11px;font-weight:700;cursor:pointer;transition:all .13s;display:none;}
.clear-bg-btn.show{display:block;}
.clear-bg-btn:hover{background:rgba(239,68,68,.07);border-color:var(--red);}
.overlay-row{display:flex;align-items:center;gap:8px;margin-top:8px;}
.overlay-lbl{font-size:11px;color:var(--text2);font-weight:600;white-space:nowrap;min-width:70px;}
.overlay-slider{flex:1;accent-color:var(--accent);cursor:pointer;}
.overlay-val{font-family:var(--mono);font-size:11px;color:var(--accent2);min-width:36px;text-align:right;}
.bg-controls{display:none;margin-top:8px;background:var(--bg3);border-radius:8px;padding:9px 10px;border:1px solid var(--border);}
.bg-controls.show{display:block;}
.bg-ctrl-row{display:flex;align-items:center;gap:8px;margin-top:6px;}
.bg-ctrl-row:first-child{margin-top:0;}
.bg-size-tabs{display:flex;gap:4px;flex-wrap:wrap;}
.bg-size-btn{font-size:10px;font-weight:700;padding:3px 8px;border-radius:5px;border:1px solid var(--border);background:var(--bg2);color:var(--text2);cursor:pointer;font-family:var(--sans);transition:all .13s;}
.bg-size-btn:hover{color:var(--text);border-color:var(--border2);}
.bg-size-btn.on{background:rgba(59,139,255,.15);color:var(--accent2);border-color:var(--accent);}

#loading-overlay{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
.loading-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:13px;color:var(--text2);font-weight:600;}

#login-screen{position:fixed;inset:0;z-index:999;background:var(--bg);display:none;align-items:center;justify-content:center;flex-direction:column;}
#login-screen.show{display:flex;}
.login-box{background:var(--bg1);border:1px solid var(--border);border-radius:20px;padding:36px 40px;width:100%;max-width:390px;box-shadow:0 20px 60px var(--shadow);animation:loginIn .4s ease;}
@keyframes loginIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.login-logo{text-align:center;margin-bottom:22px;}
.login-logo img{height:48px;object-fit:contain;filter:drop-shadow(0 2px 12px rgba(59,139,255,.3));}
.login-mode-tabs{display:flex;background:var(--bg3);border-radius:10px;padding:3px;margin-bottom:22px;gap:2px;}
.lmt{flex:1;padding:8px 6px;border:none;border-radius:8px;background:transparent;color:var(--text3);font-family:var(--sans);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:5px;}
.lmt.on{background:var(--bg1);color:var(--text);box-shadow:0 1px 6px var(--shadow);}
.lmt:not(.on):hover{color:var(--text2);}
.login-field{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:8px;padding:11px 14px;font-family:var(--sans);font-size:14px;color:var(--text);outline:none;transition:border-color .15s,box-shadow .15s;}
.login-field:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,139,255,.12);}
.login-field::placeholder{color:var(--text3);}
.login-btn{width:100%;margin-top:12px;padding:11px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:var(--sans);font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;letter-spacing:.03em;}
.login-btn:hover{filter:brightness(1.1);transform:translateY(-1px);}
.login-btn:active{transform:translateY(0);}
.login-err{display:none;margin-top:10px;padding:9px 13px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:6px;font-size:12.5px;color:var(--orange);text-align:center;line-height:1.6;font-weight:600;}
.login-save{display:flex;align-items:center;gap:8px;margin-top:12px;cursor:pointer;}
.login-save input{accent-color:var(--accent);width:14px;height:14px;cursor:pointer;}
.login-save span{font-size:12px;color:var(--text2);font-weight:500;}

.faceid-wrap{display:flex;flex-direction:column;align-items:center;gap:14px;padding:6px 0 4px;}
.faceid-ring{width:112px;height:112px;border-radius:50%;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:border-color .3s;user-select:none;}
.faceid-ring:hover{border-color:var(--accent);}
.faceid-ring.scanning{border-color:var(--accent);animation:fring 1.2s ease-in-out infinite;}
.faceid-ring.success{border-color:var(--green);animation:none;}
.faceid-ring.fail{border-color:var(--red);animation:fshake .4s ease;}
@keyframes fring{0%,100%{box-shadow:0 0 0 0 rgba(59,139,255,0)}50%{box-shadow:0 0 0 10px rgba(59,139,255,.12)}}
@keyframes fshake{0%,100%{transform:translateX(0)}20%{transform:translateX(-7px)}40%{transform:translateX(7px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
.faceid-ring::before,.faceid-ring::after{content:'';position:absolute;width:20px;height:20px;border-color:var(--accent2);border-style:solid;transition:border-color .3s;}
.faceid-ring::before{top:7px;left:7px;border-width:2.5px 0 0 2.5px;border-radius:4px 0 0 0;}
.faceid-ring::after{bottom:7px;right:7px;border-width:0 2.5px 2.5px 0;border-radius:0 0 4px 0;}
.faceid-ring.success::before,.faceid-ring.success::after{border-color:var(--orange);}
.faceid-ring.fail::before,.faceid-ring.fail::after{border-color:var(--red);}
.fid-svg{width:58px;height:58px;transition:all .3s;}
.faceid-ring.scanning .fid-svg{filter:drop-shadow(0 0 7px rgba(59,139,255,.7));}
.scan-line{position:absolute;left:14px;right:14px;height:1.5px;background:linear-gradient(90deg,transparent,var(--accent),transparent);border-radius:2px;top:30px;opacity:0;}
.faceid-ring.scanning .scan-line{animation:scanline 1.2s ease-in-out infinite;}
@keyframes scanline{0%{top:18px;opacity:0}20%{opacity:1}80%{opacity:1}100%{top:92px;opacity:0}}
.fid-status{font-size:12.5px;font-weight:600;color:var(--text2);min-height:20px;text-align:center;transition:color .2s;}
.fid-select{width:100%;background:var(--input-bg);border:1px solid var(--border);border-radius:8px;padding:10px 38px 10px 14px;color:var(--text);font-family:var(--sans);font-size:14px;outline:none;appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237a96bc' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;transition:border-color .15s;}
.fid-select:focus{border-color:var(--accent);}
.fid-hint{font-size:11px;color:var(--text3);text-align:center;margin-top:5px;}

#app{display:none;}
.topbar{height:52px;background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:10px;position:sticky;top:0;z-index:100;box-shadow:0 1px 12px var(--shadow);}
.logo img{height:34px;object-fit:contain;}
.divr{width:1px;height:20px;background:var(--border);flex-shrink:0;}
.nav-tabs{display:flex;gap:2px;}
.nb{padding:5px 13px;font-size:12.5px;font-weight:600;border-radius:6px;cursor:pointer;border:none;background:transparent;color:var(--text2);transition:all .15s;font-family:var(--sans);}
.nb:hover{background:var(--bg3);color:var(--text);}
.nb.on{background:var(--bg3);color:var(--accent2);}
.ml-auto{margin-left:auto;display:flex;align-items:center;gap:8px;}
.greet{font-size:12px;font-weight:600;color:var(--text2);padding:4px 10px;background:var(--bg3);border-radius:6px;border:1px solid var(--border);}
.greet em{color:var(--accent2);font-style:normal;}
.icon-btn{width:34px;height:34px;border-radius:7px;border:1px solid var(--border);background:var(--bg2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .15s;color:var(--text2);}
.icon-btn:hover{border-color:var(--accent);color:var(--text);}
.tgl-wrap{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--text2);font-weight:500;}
.tgl{position:relative;width:38px;height:21px;cursor:pointer;}
.tgl input{display:none;}
.tgl-t{position:absolute;inset:0;background:var(--bg3);border:1px solid var(--border);border-radius:11px;transition:.2s;}
.tgl input:checked+.tgl-t{background:var(--accent);border-color:var(--accent);}
.tgl-k{position:absolute;top:2px;left:2px;width:15px;height:15px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);}
.tgl input:checked~.tgl-k{transform:translateX(17px);}
.notif-wrap{position:relative;display:flex;align-items:center;}
.notif-btn{width:34px;height:34px;border-radius:7px;border:1px solid var(--border);background:var(--bg2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;color:var(--text2);position:relative;flex-shrink:0;}
.notif-btn:hover{border-color:var(--accent);color:var(--text);}
.notif-btn.ringing svg{animation:bellring .35s ease-in-out 2;}
@keyframes bellring{0%{transform:rotate(0)}25%{transform:rotate(-14deg)}75%{transform:rotate(14deg)}100%{transform:rotate(0)}}
.notif-dot{position:absolute;top:-3px;right:-3px;width:8px;height:8px;background:var(--red);border-radius:50%;border:2px solid var(--bg1);display:none;animation:popin .2s ease;}
.notif-dot.show{display:block;}
.notif-count{position:absolute;top:-5px;right:-5px;background:var(--red);color:#fff;border-radius:999px;font-size:9px;font-weight:700;min-width:16px;height:16px;display:none;align-items:center;justify-content:center;padding:0 3px;font-family:var(--mono);border:2px solid var(--bg1);animation:popin .2s ease;}
.notif-count.show{display:flex;}
@keyframes popin{from{transform:scale(0)}to{transform:scale(1)}}
.notif-drop{position:absolute;top:calc(100% + 8px);right:0;width:300px;background:var(--bg1);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.35);z-index:500;opacity:0;transform:translateY(-6px) scale(.97);pointer-events:none;transition:all .18s cubic-bezier(.4,0,.2,1);transform-origin:top right;}
.notif-drop.open{opacity:1;transform:none;pointer-events:auto;}
.notif-hd{display:flex;align-items:center;justify-content:space-between;padding:11px 14px 9px;border-bottom:1px solid var(--border);}
.notif-hd-title{font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--text3);}
.notif-mark{font-size:11px;font-weight:600;color:var(--accent2);cursor:pointer;border:none;background:none;font-family:var(--sans);padding:2px 7px;border-radius:4px;transition:background .13s;}
.notif-mark:hover{background:var(--bg3);}
.notif-list{max-height:290px;overflow-y:auto;padding:4px 0;}
.notif-list::-webkit-scrollbar{width:3px;}
.notif-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.notif-item{display:flex;gap:10px;padding:10px 14px;transition:background .12s;cursor:default;position:relative;animation:fu .15s ease both;}
.notif-item:hover{background:var(--bg2);}
.notif-item.unread::after{content:'';position:absolute;left:5px;top:50%;transform:translateY(-50%);width:5px;height:5px;border-radius:50%;background:var(--accent);}
.ni-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;margin-top:1px;}
.ni-blue{background:rgba(59,139,255,.12);}.ni-orange{background:rgba(245,158,11,.12);}.ni-green{background:rgba(34,197,94,.1);}.ni-purple{background:rgba(139,92,246,.1);}
.ni-body{flex:1;min-width:0;}
.ni-title{font-size:12.5px;font-weight:700;line-height:1.3;}
.notif-item.unread .ni-title{color:var(--text);}
.notif-item:not(.unread) .ni-title{color:var(--text2);}
.ni-desc{font-size:11.5px;color:var(--text2);margin-top:2px;line-height:1.5;}
.notif-item:not(.unread) .ni-desc{color:var(--text3);}
.ni-time{font-size:10px;color:var(--text3);margin-top:3px;font-family:var(--mono);}
.notif-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:26px 0 22px;gap:8px;color:var(--text3);font-size:12.5px;}
.main{max-width:960px;margin:0 auto;padding:22px 18px;}
.page{display:none;}.page.on{display:block;}
.card{background:var(--bg1);border:1px solid var(--border);border-radius:10px;padding:18px 20px;}
.card+.card,.card~.card{margin-top:12px;}
.ctitle{font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.ctitle::before{content:'';width:3px;height:13px;background:var(--accent);border-radius:2px;flex-shrink:0;}
.row{display:flex;gap:8px;align-items:center;}
.field{flex:1;background:var(--input-bg);border:1px solid var(--border);border-radius:7px;padding:9px 13px;font-family:var(--mono);font-size:13px;color:var(--text);outline:none;transition:border-color .15s,box-shadow .15s;}
.field:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,139,255,.12);}
.field::placeholder{color:var(--text3);font-size:12px;}
.mrow{display:flex;gap:8px;align-items:center;margin-bottom:7px;animation:fu .15s ease both;}
.mrow-num{font-family:var(--mono);font-size:10px;color:var(--text3);min-width:18px;text-align:right;flex-shrink:0;}
.mrow-del{width:30px;height:36px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:7px;background:transparent;color:var(--text3);cursor:pointer;transition:all .13s;font-size:16px;flex-shrink:0;}
.mrow-del:hover{border-color:var(--red);color:var(--red);background:rgba(239,68,68,.07);}
.mrow-res{margin-top:6px;margin-bottom:10px;padding-left:28px;}
.btn{font-family:var(--sans);font-size:12px;font-weight:700;letter-spacing:.03em;padding:0 16px;height:36px;border:none;border-radius:7px;cursor:pointer;transition:all .15s;white-space:nowrap;display:inline-flex;align-items:center;gap:5px;}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px);}
.btn:active{transform:translateY(0);}
.bp{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(59,139,255,.3);}
.bg2{background:var(--green);color:#fff;}
.bgh{background:var(--bg3);color:var(--text2);border:1px solid var(--border);}
.bgh:hover{color:var(--text);border-color:var(--border2);}
.bsm{padding:0 12px;height:30px;font-size:11px;}
.err{display:none;margin-top:8px;padding:7px 11px;background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.2);border-radius:6px;font-size:12px;color:var(--red);font-family:var(--mono);}
.rp{background:var(--bg2);border:1px dashed var(--border);border-radius:10px;padding:18px;margin-top:12px;min-height:130px;}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:110px;gap:8px;color:var(--text3);font-size:13px;}
.ic{background:var(--card-bg);border:1px solid var(--border);border-radius:10px;overflow:hidden;animation:fu .18s ease;}
.ic+.ic{margin-top:9px;}
.qp-results-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-top:10px;}
.qp-results-hdr{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);}
.qp-results-hdr::before{content:'';width:3px;height:11px;background:var(--green);border-radius:2px;flex-shrink:0;}
.qp-results-body{padding:10px;display:flex;flex-direction:column;gap:8px;}
#qp-results .ic{border-radius:10px !important;border:1px solid var(--border) !important;margin-top:0 !important;}
@keyframes fu{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.ic-top{display:flex;align-items:flex-start;padding:13px 14px;position:relative;}
.rarity{position:absolute;top:0;left:0;font-size:9px;font-weight:700;letter-spacing:.07em;padding:3px 9px;border-radius:0 0 6px 0;text-transform:uppercase;}
.rc0{background:#374151;color:#9ca3af;}.rc1{background:#1e3a5f;color:#60a5fa;}.rc2{background:#2d1b69;color:#a78bfa;}.rc3{background:#7c2d12;color:#fb923c;}.rc4{background:#713f12;color:#fbbf24;}
.id-badge{position:absolute;top:8px;right:11px;font-family:var(--mono);font-size:10px;color:var(--text2);background:var(--bg3);padding:2px 7px;border-radius:4px;}
.id-badge-copy{cursor:pointer;transition:all .15s;user-select:none;}
.id-badge-copy:hover{background:rgba(59,139,255,.15);color:var(--accent2);border:1px solid rgba(59,139,255,.3);}
.id-badge-copy.copied{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.3);}
.id-chip{font-family:var(--mono);font-size:10.5px;font-weight:700;padding:2px 8px;border-radius:5px;background:var(--bg3);color:var(--text3);border:1px solid var(--border);cursor:pointer;user-select:none;transition:all .15s;white-space:nowrap;flex-shrink:0;margin-top:1px;}
.id-chip:hover{background:rgba(59,139,255,.13);color:var(--accent2);border-color:rgba(59,139,255,.35);}
.id-chip.copied{background:rgba(34,197,94,.1);color:var(--green);border-color:rgba(34,197,94,.3);}
.icon-box{width:52px;height:52px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:17px;overflow:hidden;font-size:9px;color:var(--text3);font-family:var(--mono);}
.icon-box img{width:100%;height:100%;object-fit:contain;}
.ic-info{flex:1;padding-left:11px;margin-top:19px;}
.ic-name{font-size:14px;font-weight:700;color:var(--text);}
.ic-desc{font-size:12px;color:var(--text2);margin-top:2px;}
.tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
.tag{font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;}
.tb{background:rgba(59,139,255,.12);color:var(--accent2);}.to{background:rgba(245,158,11,.12);color:var(--orange);}.tp2{background:rgba(139,92,246,.1);color:var(--purple);}.tg2{background:rgba(34,197,94,.1);color:var(--green);}.tgr{background:var(--bg3);color:var(--text2);}.tcyan{background:rgba(6,182,212,.07);color:var(--cyan);opacity:.8;}
.tag-online{background:rgba(34,197,94,.08);color:var(--green);border:1px solid rgba(34,197,94,.25);}
.tag-qty{background:linear-gradient(135deg,#f59e0b,#ef4444);color:#fff;font-weight:800;letter-spacing:.03em;font-size:10.5px;padding:1px 7px;border-radius:5px;box-shadow:0 1px 6px rgba(245,100,11,.35);vertical-align:middle;margin-left:6px;display:inline-block;line-height:1.5;}
.div1{height:1px;background:var(--border);}
.ic-opts{padding:11px 14px;}
.oh{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:7px;}
.ol{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:5px;background:var(--bg2);margin-bottom:4px;animation:fu .18s ease both;}
.ol:hover{background:var(--bg3);}
.ol.nt{border-left:2px solid var(--red);padding-left:6px;}
.ol.nt .ot{color:#fca5a5;}
.on2{font-family:var(--mono);font-size:9.5px;color:var(--text3);min-width:22px;}
.ot{font-size:12.5px;color:var(--text);flex:1;}
.dl{margin-top:6px;padding:6px 9px;border-radius:5px;background:rgba(245,158,11,.07);border-left:2px solid var(--orange);font-size:11px;color:var(--orange);font-weight:500;}
.lg{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:640px){
  .lg{grid-template-columns:1fr;}
  .topbar{padding:0 10px;gap:6px;}
  .nav-tabs{gap:1px;overflow-x:auto;}
  .nb{padding:5px 9px;font-size:11.5px;white-space:nowrap;}
  .greet{display:none;}
  .main{padding:14px 10px;}
  .map-card{padding:10px 11px;gap:10px;}
  .tgl-wrap span{display:none;}
}
.lr{display:none;margin-top:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;animation:fu .15s ease;}
.lr.on{display:block;}
.lr-name{font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px;}
.lr-row{display:flex;gap:6px;margin-top:5px;flex-wrap:wrap;align-items:center;}
.lk{font-size:10px;color:var(--text3);font-family:var(--mono);}
.lv{font-size:11px;color:var(--text);font-family:var(--mono);font-weight:600;}
.map-result{margin-top:10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;display:none;animation:fu .15s ease;}
.map-result.on{display:block;}
.map-card{display:flex;align-items:center;gap:12px;background:var(--bg1);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px;animation:fu .15s ease both;cursor:default;box-shadow:0 2px 10px var(--shadow);transition:box-shadow .2s,border-color .2s;}
.map-card:hover{box-shadow:0 4px 18px var(--shadow);border-color:var(--border2);}
.map-id{font-family:var(--mono);font-size:11px;color:var(--text2);font-weight:600;}
.map-name{font-size:15.5px;font-weight:600;color:var(--orange);}
.brow{background:var(--bg2);border:1px solid var(--border);border-radius:7px;padding:9px 11px;display:flex;align-items:center;gap:7px;margin-bottom:6px;animation:fu .13s ease both;}
.bnum{font-family:var(--mono);font-size:10px;color:var(--text3);min-width:18px;}
.bsel{flex:1;background:var(--input-bg);border:1px solid var(--border);border-radius:6px;padding:6px 28px 6px 9px;color:var(--text);font-family:var(--sans);font-size:12.5px;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%237a96bc' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 9px center;}
.bsel:focus{border-color:var(--accent);}
.bval{width:110px;min-width:80px;background:var(--input-bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--accent2);font-family:var(--mono);font-size:13px;text-align:center;outline:none;transition:border-color .15s,box-shadow .15s;-moz-appearance:textfield;}
.bval:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,139,255,.12);}
.bval:disabled{color:var(--text3);opacity:.35;pointer-events:none;}
.bval::-webkit-outer-spin-button,.bval::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.bprev{font-family:var(--mono);font-size:10.5px;color:var(--text2);min-width:120px;max-width:180px;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.bdel{width:26px;height:26px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:5px;background:transparent;color:var(--text3);cursor:pointer;transition:all .13s;font-size:15px;flex-shrink:0;}
.bdel:hover{border-color:var(--red);color:var(--red);background:rgba(239,68,68,.07);}
.out{background:var(--input-bg);border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-family:var(--mono);font-size:13px;color:var(--green);word-break:break-all;min-height:44px;cursor:pointer;transition:border-color .15s;position:relative;}
.out:hover{border-color:var(--accent);}
.out.cp{border-color:var(--green);}
.out-hint{font-size:10px;color:var(--text3);position:absolute;bottom:6px;right:9px;font-family:var(--sans);}
.sep{height:1px;background:var(--border);margin:12px 0;}
.acts{display:flex;gap:8px;margin-top:12px;justify-content:flex-end;}
.id-row{display:flex;gap:8px;align-items:center;margin-bottom:10px;}
.id-lbl{font-size:12px;color:var(--text2);white-space:nowrap;font-weight:600;}
.id-f{max-width:110px;}
.iname-b{font-size:12px;font-weight:600;color:var(--green);}
.spin-sm{display:inline-block;width:12px;height:12px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:5px;}

/* ── QUICK PASTE styles ── */
.qp-chip{display:inline-flex;align-items:center;font-family:var(--mono);font-size:10.5px;font-weight:600;padding:3px 9px;border-radius:5px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:default;white-space:nowrap;max-width:160px;overflow:hidden;text-overflow:ellipsis;transition:background .13s,border-color .13s;}
.qp-chip:hover{background:rgba(59,139,255,.1);border-color:rgba(59,139,255,.3);color:var(--accent2);}
.qp-section-hdr{font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin:14px 0 6px;display:flex;align-items:center;gap:8px;}
.qp-section-hdr::before{content:'';width:3px;height:11px;background:var(--green);border-radius:2px;flex-shrink:0;}
</style>
</head>
<body>

<div id="loading-overlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Đang tải dữ liệu...</div>
</div>

<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <img src="https://ngocrongonline.com/images/logo__Tet_280x90.png" alt="DragonBoy" onerror="this.outerHTML='<div style=&quot;font-weight:800;font-size:20px;color:var(--accent2)&quot;>DragonBoy Tools</div>'">
    </div>
    <div class="login-mode-tabs">
      <button class="lmt on" id="tab-text" onclick="switchLoginMode('text')">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Nhập tên
      </button>
      <button class="lmt" id="tab-face" onclick="switchLoginMode('face')">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M16 3h3a2 2 0 0 1 2 2v3"/><path d="M8 21H5a2 2 0 0 1-2-2v-3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/><circle cx="9" cy="10" r="1" fill="currentColor"/><circle cx="15" cy="10" r="1" fill="currentColor"/><path d="M9.5 15a3.5 3.5 0 0 0 5 0"/></svg>
        Face ID
      </button>
    </div>
    <div id="panel-text">
      <input class="login-field" id="lname" placeholder="Nhập tên của bạn..." autocomplete="off" spellcheck="false"/>
      <button class="login-btn" onclick="doLogin()">Đăng nhập</button>
      <label class="login-save">
        <input type="checkbox" id="lsave" checked>
        <span>Lưu đăng nhập lần sau</span>
      </label>
    </div>
    <div id="panel-face" style="display:none">
      <div class="faceid-wrap">
        <div class="faceid-ring" id="fid-ring" onclick="startFaceScan()">
          <svg class="fid-svg" viewBox="0 0 60 60" fill="none" stroke="var(--accent2)" stroke-width="2.2" stroke-linecap="round">
            <path d="M18 21 Q21 17.5 24 21"/>
            <path d="M36 21 Q39 17.5 42 21"/>
            <line x1="21" y1="27" x2="21" y2="31"/>
            <line x1="39" y1="27" x2="39" y2="31"/>
            <path d="M29 28 L27.5 34.5 Q30 36.5 32.5 34.5 L31 28"/>
            <path d="M22 41 Q30 47 38 41"/>
          </svg>
          <div class="scan-line"></div>
        </div>
        <div class="fid-status" id="fid-status">Chọn người dùng bên dưới</div>
      </div>
      <select class="fid-select" id="fid-select" onchange="onFidSelectChange()">
        <option value="">— Chọn người dùng —</option>
        <option value="Khang">Đình Khang</option>
        <option value="Thanh">Thái Thanh</option>
        <option value="Hau">Khắc Hậu</option>
      </select>
      <div class="fid-hint">Chọn tên rồi nhấn vào khuôn mặt để quét</div>
      <label class="login-save" style="margin-top:14px;">
        <input type="checkbox" id="lsave2" checked>
        <span>Lưu đăng nhập lần sau</span>
      </label>
    </div>
    <div class="login-err" id="lerr"></div>
  </div>
</div>

<div id="app">
<div class="topbar">
  <div class="logo">
    <img src="https://ngocrongonline.com/images/logo__Tet_280x90.png" alt="DragonBoy" height="34" onerror="this.outerHTML='<span style=&quot;font-weight:800;font-size:14px;color:var(--accent2)&quot;>DragonBoy</span>'">
  </div>
  <div class="divr"></div>
  <div class="nav-tabs">
    <button class="nb on" onclick="showPage(0,this)">Kiểm tra Option</button>
    <button class="nb" onclick="showPage(1,this)">Tra cứu ID</button>
    <button class="nb" onclick="showPage(2,this)">Tra cứu Map</button>
    <button class="nb" onclick="showPage(3,this)">Tạo chuỗi</button>
    <button class="nb" onclick="window.location.href='skill/skill.html'">Tra Cứu Skill</button>
  </div>
  <div class="ml-auto">
    <div class="tgl-wrap" id="mtw">
      <span>Tra cứu nhiều Item</span>
      <label class="tgl"><input type="checkbox" id="mtg" onchange="togM()"><div class="tgl-t"></div><div class="tgl-k"></div></label>
    </div>
    <div class="divr"></div>
    <span class="greet">Xin chào, <em id="greet-name"></em>!</span>
    <div class="notif-wrap" id="notif-wrap">
      <button class="notif-btn" id="notif-btn" onclick="toggleNotif(event)" title="Thông báo">
        <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
        </svg>
      </button>
      <span class="notif-dot" id="notif-dot"></span>
      <span class="notif-count" id="notif-count"></span>
      <div class="notif-drop" id="notif-drop">
        <div class="notif-hd">
          <span class="notif-hd-title">Thông báo</span>
          <button class="notif-mark" onclick="markAllRead()">Đánh dấu đã đọc</button>
        </div>
        <div class="notif-list" id="notif-list"></div>
      </div>
    </div>
    <div class="theme-wrap" id="theme-wrap">
      <button class="theme-btn" id="theme-btn" onclick="toggleThemeDrop(event)" title="Giao diện & Màu sắc">
        <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
      </button>
      <div class="theme-drop" id="theme-drop">
        <div class="theme-drop-hd">Tùy chỉnh giao diện</div>
        <div class="theme-section">
          <div class="theme-section-lbl">Chế độ sáng / tối</div>
          <div class="base-row">
            <button class="base-btn" id="mode-dark" onclick="setBaseMode('dark')">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
              Tối
            </button>
            <button class="base-btn" id="mode-light" onclick="setBaseMode('light')">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
              Sáng
            </button>
          </div>
        </div>
        <div class="theme-section">
          <div class="theme-section-lbl">Màu nền gradient</div>
          <div class="swatches" id="swatches"></div>
        </div>
        <div class="theme-section">
          <div class="theme-section-lbl">Ảnh nền tùy chỉnh</div>
          <div class="upload-area" id="upload-area" onclick="document.getElementById('bg-upload').click()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            Tải ảnh làm background
          </div>
          <input type="file" id="bg-upload" accept="image/*" style="display:none" onchange="handleBgUpload(this)">
          <img class="upload-preview" id="upload-preview" alt="preview">
          <div class="bg-controls" id="bg-controls">
            <div class="bg-ctrl-row">
              <span class="overlay-lbl">Kích thước:</span>
              <div class="bg-size-tabs" id="bg-size-tabs">
                <button class="bg-size-btn on" onclick="setBgSize('cover')" data-v="cover">Phủ đầy</button>
                <button class="bg-size-btn" onclick="setBgSize('contain')" data-v="contain">Vừa khung</button>
                <button class="bg-size-btn" onclick="setBgSize('auto')" data-v="auto">Gốc</button>
              </div>
            </div>
            <div class="bg-ctrl-row">
              <span class="overlay-lbl">Vị trí X:</span>
              <input class="overlay-slider" type="range" min="0" max="100" value="50" id="bg-pos-x" oninput="updateBgPos()">
              <span class="overlay-val" id="bg-pos-x-val">50%</span>
            </div>
            <div class="bg-ctrl-row">
              <span class="overlay-lbl">Vị trí Y:</span>
              <input class="overlay-slider" type="range" min="0" max="100" value="50" id="bg-pos-y" oninput="updateBgPos()">
              <span class="overlay-val" id="bg-pos-y-val">50%</span>
            </div>
            <div class="bg-ctrl-row">
              <span class="overlay-lbl">Độ mờ:</span>
              <input class="overlay-slider" type="range" min="0" max="90" value="40" id="overlay-slider" oninput="updateOverlay(this.value)">
              <span class="overlay-val" id="overlay-val">40%</span>
            </div>
          </div>
          <button class="clear-bg-btn" id="clear-bg-btn" onclick="clearBg()">✕ Xóa ảnh nền</button>
        </div>
      </div>
    </div>
    <button class="icon-btn" onclick="doLogout()" title="Đăng xuất" style="font-size:13px;font-weight:700;">&#10005;</button>
  </div>
</div>

<div class="main">

<div class="page on" id="p0">
  <div id="sm">
    <div class="card">
      <div class="ctitle">Kiểm tra chuỗi option vật phẩm</div>
      <div class="row">
        <input class="field" id="si" placeholder="Nhập chuỗi option... VD: 1935x2_50,24;14,10" spellcheck="false"/>
        <button class="btn bp" onclick="checkSingle()">Kiểm tra</button>
        <button class="btn bgh bsm" onclick="clearSingle()">Xóa</button>
      </div>
      <div class="err" id="es"></div>
    </div>
    <div class="rp" id="rs">
      <div class="empty" id="rs-e">
        <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" opacity=".2"><rect x="3" y="3" width="18" height="18" rx="3"/><line x1="7" y1="8" x2="17" y2="8"/><line x1="7" y1="12" x2="13" y2="12"/><line x1="7" y1="16" x2="10" y2="16"/></svg>
        <span>Nhập chuỗi option rồi nhấn Kiểm tra</span>
      </div>
      <div id="rs-r" style="display:none"></div>
    </div>
    <div class="acts" id="as" style="display:none">
      <button class="btn bg2 bsm" onclick="cpSingle()">Sao chép kết quả</button>
      <button class="btn bgh bsm" onclick="clearSingle()">Làm mới</button>
    </div>
  </div>
  <div id="mm" style="display:none">
    <!-- ══ QUICK PASTE PANEL ══ -->
    <div class="card" id="quick-paste-card">
      <div class="ctitle" style="justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
        <span>Nhập nhanh nhiều Item (phân cách bằng @)</span>
        <div style="display:flex;align-items:center;gap:6px;">
          <span id="qp-count" style="font-size:10px;font-weight:700;color:var(--accent2);background:rgba(59,139,255,.12);padding:2px 9px;border-radius:5px;display:none;"></span>
          <span style="font-size:9px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);padding:3px 8px;border:1px solid var(--border);border-radius:5px;">@ SEPARATOR</span>
        </div>
      </div>
      <div style="position:relative;">
        <textarea id="qp-input" class="field" rows="2"
          placeholder="Dán chuỗi vào đây... VD: @454_73,0@1884x2_50,12;50,10;38,0@921_50,15;38,0;72,2"
          spellcheck="false"
          style="width:100%;resize:vertical;font-family:var(--mono);font-size:12.5px;min-height:56px;padding-right:36px;line-height:1.6;"
          oninput="onQpInput(this.value)"></textarea>
        <button onclick="clearQp()" title="Xóa"
          style="position:absolute;top:8px;right:8px;background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:18px;line-height:1;padding:1px 5px;transition:color .13s;"
          onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--text3)'">×</button>
      </div>
      <!-- Chips preview -->
      <div id="qp-chips" style="display:none;margin-top:9px;flex-wrap:wrap;gap:5px;padding:8px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;min-height:36px;"></div>
      <div style="display:flex;gap:8px;margin-top:9px;align-items:center;flex-wrap:wrap;">
        <button class="btn bp bsm" id="qp-check-btn" onclick="checkQp()" style="display:none;gap:5px;">
          <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
          Kiểm tra tất cả
        </button>
        <button class="btn bgh bsm" id="qp-to-rows-btn" onclick="qpToRows()" style="display:none;">
          Chuyển sang dạng hàng ↓
        </button>
        <button class="btn bgh bsm" id="qp-clear-all-btn" onclick="clearQp()" style="display:none;">Xóa tất cả</button>
      </div>
    </div>

    <!-- QP RESULTS -->
    <div id="qp-results"></div>

    <!-- ══ MANUAL ROWS ══ -->
    <div class="card" id="manual-rows-card" style="margin-top:12px;display:none;background:var(--bg1);border:1px solid var(--border2);">
      <div class="ctitle">Nhập từng chuỗi (mỗi dòng 1 item)</div>
      <div id="mrows"></div>
      <div style="display:flex;gap:8px;margin-top:4px;align-items:center;">
        <button class="btn bgh bsm" onclick="addMRow()" style="gap:4px;">
          <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Thêm
        </button>
        <button class="btn bp bsm" onclick="checkAllRows()">Kiểm tra tất cả</button>
        <button class="btn bgh bsm" onclick="clearAllRows()">Xóa tất cả</button>
      </div>
    </div>
  </div>
</div>

<div class="page" id="p1">
  <div class="lg">
    <div class="card">
      <div class="ctitle">Tra cứu Item (ID hoặc tên)</div>
      <div class="row">
        <input class="field" id="li" placeholder="ID (VD: 1935) hoặc tên..." onkeydown="if(event.key==='Enter')lI()"/>
        <button class="btn bp bsm" onclick="lI()">Tra</button>
      </div>
      <div class="lr" id="lir"></div>
    </div>
    <div class="card">
      <div class="ctitle">Tra cứu Option (ID hoặc tên)</div>
      <div class="row">
        <input class="field" id="lo" placeholder="ID (VD: 50) hoặc tên..." onkeydown="if(event.key==='Enter')lO()"/>
        <button class="btn bp bsm" onclick="lO()">Tra</button>
      </div>
      <div class="lr" id="lor"></div>
    </div>
  </div>
</div>

<div class="page" id="p2">
  <div class="card">
    <div class="ctitle">Tra cứu Map (ID hoặc tên)</div>
    <div class="row">
      <input class="field" id="mi2" placeholder="Nhập ID map (VD: 1) hoặc tên (VD: Đồi hoa cúc)..." onkeydown="if(event.key==='Enter')lM()"/>
      <button class="btn bp" onclick="lM()">Tra cứu</button>
      <button class="btn bgh bsm" onclick="clearMap()">Xóa</button>
    </div>
    <div class="map-result" id="mr"></div>
  </div>
</div>

<div class="page" id="p3">
  <div class="card">
    <div class="ctitle">Tạo chuỗi option</div>
    <div class="id-row">
      <span class="id-lbl">Item ID:</span>
      <input class="field id-f" id="bid" placeholder="VD: 1935" oninput="uo()"/>
      <div id="b-icon" style="width:36px;height:36px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;display:none;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;"></div>
      <span id="bin"></span>
      <button class="btn bgh bsm" id="qty-btn" onclick="toggleQty()" style="margin-left:8px;">+ Thêm số lượng</button>
      <div id="qty-wrap" style="display:none;align-items:center;gap:6px;">
        <input class="field" id="bqty" placeholder="VD: 5" inputmode="numeric" oninput="uo()" style="max-width:72px;"/>
        <button class="bdel" onclick="removeQty()" title="Xóa số lượng">×</button>
      </div>
      <span id="bqtyp" style="font-size:12px;color:var(--accent2);font-family:var(--mono);font-weight:600;"></span>
    </div>
    <div class="sep"></div>
    <div id="br"><div style="color:var(--text3);font-size:13px;padding:6px 0">Nhấn "Thêm option" để bắt đầu</div></div>
    <button class="btn bgh bsm" onclick="abr()" style="margin-top:6px;">+ Thêm option</button>
  </div>
  <div class="card">
    <div class="ctitle">Chuỗi kết quả</div>
    <div class="out" id="ob" onclick="cpO()">
      <span id="ot" style="color:var(--text3)">— chưa có dữ liệu —</span>
      <span class="out-hint">Click để copy</span>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button class="btn bg2 bsm" onclick="cpO()">Sao chép chuỗi</button>
      <button class="btn bgh bsm" onclick="rB()">Reset</button>
    </div>
  </div>
</div>

</div>
</div>

<script>
const ONLINE_ITEMS_URL = 'https://electroheavenvn.github.io/DataNRO/TeaMobi/Server1/ItemTemplates.json';
const ONLINE_ICON_BASE = 'https://electroheavenvn.github.io/DataNRO/TeaMobi/Icons/';

let ID = {}, OD = {}, MD = [];
let onlineCache = {};
let onlineItemsAll = null;
let onlineLoadPromise = null;

async function tryFetch(names) {
  for (const n of names) {
    try { const r = await fetch(n); if (r.ok) return r; } catch(e) {}
  }
  return null;
}

async function loadData() {
  const loadEl = document.querySelector('.loading-text');
  try {
    loadEl.textContent = 'Đang tìm items.json...';
    const a = await tryFetch(['items.json','Items.json','item.json','Item.json']);
    if (!a) throw new Error('Không tìm thấy items.json — kiểm tra lại tên file!');
    loadEl.textContent = 'Đang tìm options.json...';
    const b = await tryFetch(['options.json','Options.json','option.json','Option.json']);
    if (!b) throw new Error('Không tìm thấy options.json — kiểm tra lại tên file!');
    loadEl.textContent = 'Đang tìm Maps.json...';
    const c = await tryFetch(['Maps.json','maps.json','map.json','Map.json']);
    if (!c) throw new Error('Không tìm thấy Maps.json — kiểm tra lại tên file!');
    loadEl.textContent = 'Đang xử lý dữ liệu...';
    ID = await a.json();
    const optsRaw = await b.json();
    OD = Array.isArray(optsRaw) ? Object.fromEntries(optsRaw.map(o => [String(o.id), o])) : optsRaw;
    MD = await c.json();
    document.getElementById('loading-overlay').style.display = 'none';
    buildSelOpts();
    initMRows();
    checkSavedLogin();
  } catch(err) {
    loadEl.textContent = '❌ ' + err.message;
    loadEl.style.color = 'var(--red)';
    loadEl.style.fontSize = '13px';
    loadEl.style.maxWidth = '320px';
    loadEl.style.textAlign = 'center';
    loadEl.style.lineHeight = '1.6';
  }
}
loadData();

function normalizeOnlineItem(o) {
  return { id: o.id, name: o.name || '', description: o.description || '', level: o.level || 1, type: o.type != null ? o.type : 0, gender: o.gender != null ? o.gender : 3, part: o.part != null ? o.part : -1, iconId: o.icon != null ? o.icon : null, icon: o.icon != null ? o.icon : null, _online: true };
}

async function fetchOnlineAll() {
  if (onlineItemsAll) return onlineItemsAll;
  if (onlineLoadPromise) return onlineLoadPromise;
  onlineLoadPromise = fetch(ONLINE_ITEMS_URL).then(r => r.json()).then(arr => {
    onlineItemsAll = arr;
    arr.forEach(o => { onlineCache[String(o.id)] = normalizeOnlineItem(o); });
    return onlineItemsAll;
  }).catch(() => { onlineItemsAll = []; return []; });
  return onlineLoadPromise;
}

async function fetchOnlineById(id) {
  const sid = String(id);
  if (onlineCache[sid]) return onlineCache[sid];
  await fetchOnlineAll();
  return onlineCache[sid] || null;
}

async function getItemAsync(id) {
  const sid = String(id);
  if (ID[sid]) return { item: ID[sid], online: false };
  const onl = await fetchOnlineById(sid);
  return { item: onl, online: !!onl };
}

function getIconUrl(item) {
  if (!item) return null;
  const iconVal = item.icon != null ? item.icon : (item.iconId != null ? item.iconId : null);
  if (iconVal == null) return null;
  if (item._online) return ONLINE_ICON_BASE + iconVal + '.png';
  else return 'small/Small' + iconVal + '.png';
}

function iconBoxHtml(item, iid) {
  const url = getIconUrl(item);
  if (url) {
    const iconVal = item ? (item.icon != null ? item.icon : item.iconId) : null;
    const onlineFallback = iconVal != null ? (ONLINE_ICON_BASE + iconVal + '.png') : '';
    const fallbackScript = onlineFallback
      ? `this.onerror=function(){this.src='small/Small999999.png'};this.src='${onlineFallback}'`
      : `this.src='small/Small999999.png'`;
    return '<img src="' + url + '" onerror="' + fallbackScript + '" alt="">';
  }
  return '<img src="small/Small999999.png" alt="">';
}

/* NOTIFICATIONS */
const NOTIFS = [
  {id:'tb003',emoji:'🔒',title:'Vừa mới cập nhật',desc:'Cập nhật thêm trang web tra cứu skill, chỉ cần check trên local lấy skill dán vô là được.',time:'01/03/2026'},
  {id:'tb002',emoji:'🎨',title:'Cập nhật: Tùy chỉnh giao diện nâng cao',desc:'Thêm 15 màu gradient, upload ảnh anime làm nền, điều chỉnh độ mờ. Nhấn icon ⚙️ góc phải topbar để khám phá!',time:'01/03/2026'},
  {id:'tb001',emoji:'🔒',title:'Cập nhật trước đó',desc:'Thêm hiển thị hình ảnh và tối ưu các lỗi ở bản cũ.',time:'27/02/2026'},
];
const RK = 'db_nread';
function getRead(){try{return new Set(JSON.parse(localStorage.getItem(RK)||'[]'));}catch(e){return new Set();}}
function addRead(id){const s=getRead();s.add(id);localStorage.setItem(RK,JSON.stringify([...s]));}
function readAll(){localStorage.setItem(RK,JSON.stringify(NOTIFS.map(n=>n.id)));}
function unreadCount(){const r=getRead();return NOTIFS.filter(n=>!r.has(n.id)).length;}
const EMOJI_CLS={'🔒':'ni-blue','🔧':'ni-orange','✨':'ni-green','⚠️':'ni-orange','🔔':'ni-purple'};
function updateBell(){
  const cnt=unreadCount();
  document.getElementById('notif-dot').classList.toggle('show',cnt>0);
  const el=document.getElementById('notif-count');
  if(cnt>0){el.textContent=cnt>9?'9+':cnt;el.classList.add('show');}else el.classList.remove('show');
  const btn=document.getElementById('notif-btn');
  if(cnt>0){btn.classList.add('ringing');setTimeout(()=>btn.classList.remove('ringing'),800);}
}
function renderNotifs(){
  const list=document.getElementById('notif-list');
  const read=getRead();
  if(!NOTIFS.length){list.innerHTML='<div class="notif-empty">Chưa có thông báo nào</div>';return;}
  list.innerHTML=NOTIFS.map((n,i)=>{
    const unread=!read.has(n.id);
    const cls=EMOJI_CLS[n.emoji]||'ni-blue';
    return`<div class="notif-item${unread?' unread':''}" style="animation-delay:${i*.04}s" onclick="onClickNotif('${n.id}',this)">
      <div class="ni-icon ${cls}">${n.emoji}</div>
      <div class="ni-body">
        <div class="ni-title">${esc(n.title)}</div>
        <div class="ni-desc">${esc(n.desc)}</div>
        <div class="ni-time">${n.time}</div>
      </div>
    </div>`;
  }).join('');
}
function onClickNotif(id,el){addRead(id);el.classList.remove('unread');updateBell();}
function markAllRead(){readAll();document.querySelectorAll('.notif-item').forEach(el=>el.classList.remove('unread'));updateBell();}
let notifOpen=false;
function toggleNotif(e){
  e.stopPropagation();notifOpen=!notifOpen;
  document.getElementById('notif-drop').classList.toggle('open',notifOpen);
  if(notifOpen)renderNotifs();
}
function closeNotif(){notifOpen=false;document.getElementById('notif-drop').classList.remove('open');}
document.addEventListener('click',e=>{if(!document.getElementById('notif-wrap').contains(e.target))closeNotif();});

/* AUTH */
const MEMBERS = ['Khang','Thanh','Hau'];
const TROLL_MSG = { 'Phi': 'Phi làm lồn gì mà được vô đây??? Troll dị á, mày không có quyền!!' };
function normName(n){return n.trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\u0111/g,'d');}
const NORM_MAP = Object.fromEntries(MEMBERS.map(m=>[normName(m),m]));
function showErr(msg){const e=document.getElementById('lerr');e.innerHTML=msg;e.style.display='block';}
function hideErr(){document.getElementById('lerr').style.display='none';}
function enterApp(name){
  document.getElementById('login-screen').classList.remove('show');
  document.getElementById('app').style.display='block';
  document.getElementById('greet-name').textContent=name;
  updateBell();
}
function doLogout(){
  localStorage.removeItem('db_user');
  document.getElementById('login-screen').classList.add('show');
  document.getElementById('app').style.display='none';
  document.getElementById('lname').value='';
  hideErr();resetFaceId();
}
function checkSavedLogin(){
  const saved=localStorage.getItem('db_user');
  if(saved&&TROLL_MSG[saved]){localStorage.removeItem('db_user');document.getElementById('login-screen').classList.add('show');return;}
  if(saved&&MEMBERS.includes(saved))enterApp(saved);
  else document.getElementById('login-screen').classList.add('show');
}
function doLogin(){
  const val=document.getElementById('lname').value.trim();
  const norm=normName(val);
  const matched=NORM_MAP[norm];
  if(matched&&TROLL_MSG[matched]){showErr(TROLL_MSG[matched]);document.getElementById('lname').style.borderColor='var(--red)';return;}
  if(!matched){showErr('Tên sai rồi nha Bro! Chỉ dành cho nội bộ thôi nhé.');document.getElementById('lname').style.borderColor='var(--red)';return;}
  hideErr();
  if(document.getElementById('lsave').checked)localStorage.setItem('db_user',matched);
  enterApp(matched);
}
document.getElementById('lname').addEventListener('keydown',ev=>{if(ev.key==='Enter')doLogin();});
document.getElementById('lname').addEventListener('input',function(){this.style.borderColor='';hideErr();});

function switchLoginMode(mode){
  const isFace=mode==='face';
  document.getElementById('panel-text').style.display=isFace?'none':'block';
  document.getElementById('panel-face').style.display=isFace?'block':'none';
  document.getElementById('tab-text').classList.toggle('on',!isFace);
  document.getElementById('tab-face').classList.toggle('on',isFace);
  hideErr();
  if(!isFace)resetFaceId();
}
let fidScanning=false;
function onFidSelectChange(){
  const val=document.getElementById('fid-select').value;
  const st=document.getElementById('fid-status');
  const ring=document.getElementById('fid-ring');
  ring.className='faceid-ring';hideErr();fidScanning=false;
  if(val)st.textContent='Nhấn vào khuôn mặt để quét';
  else st.textContent='Chọn người dùng bên dưới';
}
function resetFaceId(){
  document.getElementById('fid-select').value='';
  document.getElementById('fid-ring').className='faceid-ring';
  document.getElementById('fid-status').textContent='Chọn người dùng bên dưới';
  fidScanning=false;hideErr();
}
function startFaceScan(){
  if(fidScanning)return;
  const name=document.getElementById('fid-select').value;
  if(!name){document.getElementById('fid-status').textContent='Chưa chọn người dùng kìa!';return;}
  fidScanning=true;
  const ring=document.getElementById('fid-ring'),st=document.getElementById('fid-status');
  hideErr();
  ring.className='faceid-ring scanning';st.textContent='Đang quét khuôn mặt...';st.style.color='var(--accent2)';
  setTimeout(()=>{
    fidScanning=false;
    if(TROLL_MSG[name]){ring.className='faceid-ring fail';st.textContent='Nhận diện thất bại!';st.style.color='var(--red)';setTimeout(()=>showErr(TROLL_MSG[name]),200);return;}
    ring.className='faceid-ring success';st.textContent='Xác thực thành công!';st.style.color='var(--green)';
    if(document.getElementById('lsave2').checked)localStorage.setItem('db_user',name);
    setTimeout(()=>enterApp(name),700);
  },1600);
}

/* THEME / PAGES */
const GRADIENTS = [
  {id:'g1',label:'Xanh ngọc',css:'linear-gradient(45deg,#0c675e,#069e90)'},
  {id:'g2',label:'Cầu vồng',css:'linear-gradient(135deg,rgba(165,42,4,.89),rgba(113,102,8,.89),rgba(13,95,16,.93),rgba(4,79,88,.94),rgba(19,56,86,.9),rgba(24,32,78,.94),rgba(100,8,115,.95))'},
  {id:'g3',label:'Xám tối',css:'linear-gradient(45deg,#29323c,#485563)'},
  {id:'g4',label:'Nâu đất',css:'linear-gradient(45deg,#795548,#945c48)'},
  {id:'g5',label:'Xanh dương',css:'linear-gradient(45deg,#1565C0,#1E88E5)'},
  {id:'g6',label:'Tím',css:'linear-gradient(45deg,#65379b,#886aea)'},
  {id:'g7',label:'Đỏ hồng',css:'linear-gradient(180deg,#ff5447,#f1076f)'},
  {id:'g8',label:'Xanh lá',css:'linear-gradient(180deg,#08a50e,#69bb03)'},
  {id:'g9',label:'Tím xanh',css:'linear-gradient(45deg,#6a11cb,#2575fc)'},
  {id:'g10',label:'Hoàng hôn',css:'linear-gradient(135deg,#f093fb,#f5576c)'},
  {id:'g11',label:'Đại dương',css:'linear-gradient(135deg,#0072ff,#00c6ff)'},
  {id:'g12',label:'Vàng cam',css:'linear-gradient(135deg,#f7971e,#ffd200)'},
  {id:'g13',label:'Sakura',css:'linear-gradient(135deg,#fbc2eb,#a18cd1)'},
  {id:'g14',label:'Thiên hà',css:'linear-gradient(135deg,#1a1a2e,#16213e,#0f3460,#533483)'},
  {id:'g15',label:'Mặt trời',css:'linear-gradient(135deg,#fc4a1a,#f7b733)'},
];

let currentBase=localStorage.getItem('db_base')||'dark';
let currentGrad=localStorage.getItem('db_grad')||'';
let currentBgImg=null;
let currentOverlay=parseInt(localStorage.getItem('db_overlay')||'40');
let currentBgSize=localStorage.getItem('db_bgsize')||'cover';
let currentBgPosX=parseInt(localStorage.getItem('db_bgposx')||'50');
let currentBgPosY=parseInt(localStorage.getItem('db_bgposy')||'50');
let themeDropOpen=false;

function buildSwatches(){
  const c=document.getElementById('swatches');
  c.innerHTML=GRADIENTS.map(g=>`<div class="swatch" id="sw-${g.id}" style="background:${g.css}" title="${g.label}" onclick="setGrad('${g.id}')"></div>`).join('');
}
function setBaseMode(mode){
  currentBase=mode;localStorage.setItem('db_base',mode);
  document.documentElement.setAttribute('data-theme',mode);
  document.getElementById('mode-dark').classList.toggle('on',mode==='dark');
  document.getElementById('mode-light').classList.toggle('on',mode==='light');
}
function setGrad(id){
  if(currentBgImg){currentBgImg=null;localStorage.removeItem('db_bgimg');document.getElementById('upload-preview').classList.remove('show');document.getElementById('clear-bg-btn').classList.remove('show');document.getElementById('bg-controls').classList.remove('show');}
  if(currentGrad===id){currentGrad='';localStorage.removeItem('db_grad');document.getElementById('sw-'+id).classList.remove('on');applyBg();}
  else{if(currentGrad)document.getElementById('sw-'+currentGrad).classList.remove('on');currentGrad=id;localStorage.setItem('db_grad',id);document.getElementById('sw-'+id).classList.add('on');applyBg();}
}
function applyBg(){
  const body=document.body;
  if(currentBgImg){
    body.style.backgroundImage=`url(${currentBgImg})`;body.style.backgroundSize=currentBgSize;body.style.backgroundPosition=`${currentBgPosX}% ${currentBgPosY}%`;body.style.backgroundAttachment='fixed';body.style.backgroundRepeat='no-repeat';body.classList.add('has-bg');
    let ov=document.getElementById('bg-overlay-div');
    if(!ov){ov=document.createElement('div');ov.id='bg-overlay-div';ov.style.cssText='position:fixed;inset:0;z-index:0;pointer-events:none;transition:background .3s;';document.body.insertBefore(ov,document.body.firstChild);}
    const op=currentOverlay/100;const base=currentBase==='dark'?`0,0,0`:`255,255,255`;ov.style.background=`rgba(${base},${op})`;ov.style.display='block';
  }else if(currentGrad){
    const g=GRADIENTS.find(x=>x.id===currentGrad);body.style.backgroundImage=g?g.css:'';body.style.backgroundSize='100% 100%';body.style.backgroundAttachment='fixed';body.style.backgroundRepeat='';body.classList.add('has-bg');
    const ov=document.getElementById('bg-overlay-div');if(ov)ov.style.display='none';
  }else{
    body.style.backgroundImage='';body.style.backgroundSize='';body.style.backgroundAttachment='';body.style.backgroundRepeat='';body.classList.remove('has-bg');
    const ov=document.getElementById('bg-overlay-div');if(ov)ov.style.display='none';
  }
}

let _idb=null;
function openIDB(){if(_idb)return Promise.resolve(_idb);return new Promise((res,rej)=>{const req=indexedDB.open('dragonboy_tool',1);req.onupgradeneeded=e=>e.target.result.createObjectStore('kv');req.onsuccess=e=>{_idb=e.target.result;res(_idb);};req.onerror=()=>rej(req.error);});}
function idbSet(key,val){return openIDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction('kv','readwrite');tx.objectStore('kv').put(val,key);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);}));}
function idbGet(key){return openIDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction('kv','readonly');const req=tx.objectStore('kv').get(key);req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error);}));}
function idbDel(key){return openIDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction('kv','readwrite');tx.objectStore('kv').delete(key);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);}));}

function handleBgUpload(input){
  const file=input.files[0];if(!file)return;
  const uploadArea=document.getElementById('upload-area');const origHTML=uploadArea.innerHTML;
  uploadArea.innerHTML='<span class="spin-sm"></span> Đang nén ảnh...';uploadArea.style.pointerEvents='none';
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const MAX=1280;let w=img.width,h=img.height;
      if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX;}else{w=Math.round(w*MAX/h);h=MAX;}}
      const canvas=document.createElement('canvas');canvas.width=w;canvas.height=h;canvas.getContext('2d').drawImage(img,0,0,w,h);
      let q=0.82,compressed=canvas.toDataURL('image/jpeg',q);
      if(compressed.length>3_000_000){q=0.65;compressed=canvas.toDataURL('image/jpeg',q);}
      if(compressed.length>2_000_000){q=0.50;compressed=canvas.toDataURL('image/jpeg',q);}
      uploadArea.innerHTML=origHTML;uploadArea.style.pointerEvents='';
      currentBgImg=compressed;
      if(currentGrad){document.getElementById('sw-'+currentGrad).classList.remove('on');currentGrad='';localStorage.removeItem('db_grad');}
      idbSet('db_bgimg',compressed).catch(()=>{});
      _showBgControls();applyBg();
    };
    img.onerror=()=>{uploadArea.innerHTML=origHTML;uploadArea.style.pointerEvents='';alert('Không đọc được ảnh!');};
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}
function _showBgControls(){
  document.getElementById('upload-preview').src=currentBgImg;document.getElementById('upload-preview').classList.add('show');document.getElementById('clear-bg-btn').classList.add('show');document.getElementById('bg-controls').classList.add('show');
  document.getElementById('overlay-slider').value=currentOverlay;document.getElementById('overlay-val').textContent=currentOverlay+'%';
  document.getElementById('bg-pos-x').value=currentBgPosX;document.getElementById('bg-pos-x-val').textContent=currentBgPosX+'%';
  document.getElementById('bg-pos-y').value=currentBgPosY;document.getElementById('bg-pos-y-val').textContent=currentBgPosY+'%';
  document.querySelectorAll('.bg-size-btn').forEach(b=>b.classList.toggle('on',b.dataset.v===currentBgSize));
}
function clearBg(){currentBgImg=null;idbDel('db_bgimg').catch(()=>{});localStorage.removeItem('db_bgimg');document.getElementById('upload-preview').classList.remove('show');document.getElementById('upload-preview').src='';document.getElementById('clear-bg-btn').classList.remove('show');document.getElementById('bg-controls').classList.remove('show');document.getElementById('bg-upload').value='';applyBg();}
function updateOverlay(val){currentOverlay=parseInt(val);localStorage.setItem('db_overlay',currentOverlay);document.getElementById('overlay-val').textContent=currentOverlay+'%';applyBg();}
function setBgSize(val){currentBgSize=val;localStorage.setItem('db_bgsize',val);document.querySelectorAll('.bg-size-btn').forEach(b=>b.classList.toggle('on',b.dataset.v===val));applyBg();}
function updateBgPos(){currentBgPosX=parseInt(document.getElementById('bg-pos-x').value);currentBgPosY=parseInt(document.getElementById('bg-pos-y').value);document.getElementById('bg-pos-x-val').textContent=currentBgPosX+'%';document.getElementById('bg-pos-y-val').textContent=currentBgPosY+'%';localStorage.setItem('db_bgposx',currentBgPosX);localStorage.setItem('db_bgposy',currentBgPosY);applyBg();}

function toggleThemeDrop(e){e.stopPropagation();themeDropOpen=!themeDropOpen;document.getElementById('theme-drop').classList.toggle('open',themeDropOpen);}
function closeThemeDrop(){themeDropOpen=false;document.getElementById('theme-drop').classList.remove('open');}
document.addEventListener('click',e=>{if(!document.getElementById('theme-wrap').contains(e.target))closeThemeDrop();});

function initTheme(){
  buildSwatches();setBaseMode(currentBase);
  if(currentGrad){const el=document.getElementById('sw-'+currentGrad);if(el)el.classList.add('on');}
  const legacyImg=localStorage.getItem('db_bgimg');
  if(legacyImg){currentBgImg=legacyImg;idbSet('db_bgimg',legacyImg).then(()=>localStorage.removeItem('db_bgimg')).catch(()=>{});_showBgControls();applyBg();}
  else{idbGet('db_bgimg').then(img=>{if(img){currentBgImg=img;_showBgControls();applyBg();}else{applyBg();}}).catch(()=>applyBg());}
}

function showPage(i,el){
  document.querySelectorAll('.page').forEach((p,j)=>p.classList.toggle('on',j===i));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  const mtw=document.getElementById('mtw');
  mtw.style.opacity=i===0?'1':'0.3';
  mtw.style.pointerEvents=i===0?'auto':'none';
}
function togM(){
  const on=document.getElementById('mtg').checked;
  document.getElementById('sm').style.display=on?'none':'block';
  document.getElementById('mm').style.display=on?'block':'none';
  if(!on){
    // Khi tắt toggle, ẩn manual card + reset
    document.getElementById('manual-rows-card').style.display='none';
    document.getElementById('qp-results').innerHTML='';
    document.getElementById('qp-input').value='';
    onQpInput('');
  }
}

/* UTILS */
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function vi(s){return s?String(s).split('|')[0]:'';}
function fo(d,v){if(!d)return null;return vi(d.name).replace(/#/g,parseInt(v)||0);}
function cpId(el,id){
  navigator.clipboard.writeText(String(id)).then(()=>{
    const orig=el.textContent;el.textContent='✓ Đã Coppy';el.classList.add('copied');
    setTimeout(()=>{el.textContent=orig;el.classList.remove('copied');},1500);
  });
}
function gr(lvl){
  if(lvl<=5)return['CHUNG','rc0'];if(lvl<=30)return['HIẾM','rc1'];if(lvl<=60)return['QUÝ','rc2'];if(lvl<=90)return['SỬ THI','rc3'];return['HUYỀN THOẠI','rc4'];
}
const TN={0:'Áo',1:'Quần',2:'Găng',3:'Giày',4:'Phụ kiện',5:'Cải Trang',6:'Thức ăn',7:'Sách',8:'Vật phẩm nhiệm vụ',9:'Vàng',10:'Tài nguyên',11:'Đeo lưng',12:'Ngọc rồng',13:'Nguyên liệu',18:'Pet',19:'Bông Tai',23:'Phương tiện',27:'Đạo cụ',28:'Trạng Thái',29:'Mảnh ghép',30:'Huy chương',33:'Kỹ năng',36:'Danh hiệu',37:'Sách KN'};
const GN={'0':'Trái Đất','1':'Namec','2':'Xayda','3':'Chung'};
function getG(g){return GN[String(g)]||'Chung';}
function gCls(g){const m={'0':'tcyan','1':'tg2','2':'to','3':'tgr'};return m[String(g)]||'tgr';}

let selOpts='';
function buildSelOpts(){
  selOpts='<option value="">-- Chọn option --</option>'+Object.entries(OD).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).map(([k,v])=>'<option value="'+k+'">'+k+' - '+esc(vi(v.name))+'</option>').join('');
}

function parseSync(s){
  s=s.trim();const u=s.indexOf('_');if(u<0)return null;
  let rawId=s.slice(0,u),rest=s.slice(u+1);
  let qty=null;const qtyMatch=rawId.match(/^(\d+)[xX](\d+)$/);
  if(qtyMatch){rawId=qtyMatch[1];qty=parseInt(qtyMatch[2]);}
  const iid=rawId;const item=ID[iid]||null;
  const opts=[];
  if(rest){for(const p of rest.split(';')){if(!p.trim())continue;const pts=p.split(',');opts.push({id:pts[0],val:pts[1]||'0',data:OD[pts[0]]||null});}}
  return{iid,item,opts,qty,online:false};
}

async function parseAsync(s){
  const p=parseSync(s);if(!p)return null;
  if(!p.item){const{item,online}=await getItemAsync(p.iid);p.item=item;p.online=online;}
  return p;
}

function ric(p){
  if(!p)return'<div class="empty"><span style="color:var(--red)">Định dạng không hợp lệ</span></div>';
  const{iid,item,opts}=p;const qty=p.qty||null;
  const name=item?vi(item.name):'[Item ID: '+iid+']';const desc=item?vi(item.description||''):'';  
  const lvl=item?(item.level||1):1;const[rl,rc]=gr(lvl);
  const typeName=item?(TN[item.type]||'Type '+item.type):'';
  const part=item?item.part:null;const gender=item!=null?item.gender:null;
  const isDanh=desc==='Danh hieu'||desc==='Danh hiệu';
  const iconH=iconBoxHtml(item,iid);
  let optsH='';
  opts.forEach((o,i)=>{const label=o.data?fo(o.data,o.val):'[Option '+o.id+']';const nt=o.id==='30';optsH+='<div class="ol'+(nt?' nt':'')+'" style="animation-delay:'+(i*.04)+'s"><span class="on2">'+o.id+'</span><span class="ot">'+esc(label)+'</span></div>';});
  const gn=getG(gender),gc=gCls(gender);
  const gTag=(gender!=null&&gender!==3)?'<span class="tag '+gc+'">'+esc(gn)+'</span>':'';
  const ptag=(part!=null&&part>=0)?(isDanh?'<span class="tag tp2">Danh hiệu #'+part+'</span>':'<span class="tag tgr">Part '+part+'</span>'):'';
  const qtyInline=qty?'<span class="tag-qty">Số Lượng '+qty+'</span>':'';
  const realId=String(item?item.id:iid);
  return'<div class="ic">'
    +'<div class="ic-top">'
    +'<span class="rarity '+rc+'">'+rl+'</span>'
    +'<span class="id-badge id-badge-copy" onclick="cpId(this,\''+realId+'\')" title="Click để copy ID">ID: '+esc(realId)+'</span>'
    +'<div class="icon-box">'+iconH+'</div>'
    +'<div class="ic-info">'
    +'<div class="ic-name">'+esc(name)+qtyInline+'</div>'
    +(desc&&!isDanh?'<div class="ic-desc">'+esc(desc)+'</div>':'')
    +'<div class="tags">'
    +(typeName?'<span class="tag tb">'+esc(typeName)+'</span>':'')
    +(lvl>1?'<span class="tag to">Lv.'+lvl+'</span>':'')
    +gTag+ptag
    +'</div>'
    +'</div></div>'
    +(opts.length
      ?'<div class="div1"></div><div class="ic-opts"><div class="oh">Options ('+opts.length+')</div>'+optsH+(isDanh?'<div class="dl">Danh hiệu — thứ tự #'+part+'</div>':'')+'</div>'
      :(desc?'<div class="div1"></div><div class="ic-opts"><div class="dl">'+esc(desc)+'</div></div>':''))
    +'</div>';
}

function bt(p){
  if(!p)return'';const{iid,item,opts}=p;const qty=p.qty||null;
  const lines=[(item?vi(item.name):'['+iid+']')+(qty?' x'+qty:'')];
  opts.forEach(o=>lines.push(o.data?fo(o.data,o.val):'[Option '+o.id+']'));
  const desc=item?vi(item.description||''):'';if(desc)lines.push('----'+desc);
  return lines.join('\n');
}

/* SINGLE INPUT */
let singleRes=null;
async function checkSingle(){
  const v=document.getElementById('si').value.trim();const ee=document.getElementById('es');
  if(!v){ee.textContent='Chưa nhập chuỗi nào!';ee.style.display='block';return;}
  ee.style.display='none';
  document.getElementById('rs-e').style.display='none';
  document.getElementById('rs-r').innerHTML='<div class="empty"><span class="spin-sm"></span><span style="color:var(--text2)">Đang tra cứu...</span></div>';
  document.getElementById('rs-r').style.display='block';
  document.getElementById('as').style.display='none';
  singleRes=await parseAsync(v);
  document.getElementById('rs-r').innerHTML=ric(singleRes);
  document.getElementById('as').style.display='flex';
}
function clearSingle(){document.getElementById('si').value='';document.getElementById('rs-e').style.display='flex';document.getElementById('rs-r').style.display='none';document.getElementById('as').style.display='none';document.getElementById('es').style.display='none';singleRes=null;}
function cpSingle(){if(!singleRes)return;const txt=bt(singleRes);navigator.clipboard.writeText(txt).then(()=>{const b=event.currentTarget;const o=b.innerHTML;b.textContent='Đã copy!';setTimeout(()=>b.innerHTML=o,2000);});}

/* ══════════════════════════════════════════════
   QUICK PASTE — phân cách bằng @
══════════════════════════════════════════════ */
function parseQpStr(raw) {
  // Tách bằng @ — bỏ phần tử rỗng, trim khoảng trắng
  return raw.split('@').map(s => s.trim()).filter(s => s.length > 0);
}

function onQpInput(val) {
  const strs = parseQpStr(val);
  const chipsEl = document.getElementById('qp-chips');
  const countEl = document.getElementById('qp-count');
  const checkBtn = document.getElementById('qp-check-btn');
  const toRowsBtn = document.getElementById('qp-to-rows-btn');
  const resultsEl = document.getElementById('qp-results');

  // Clear kết quả cũ khi user edit lại
  resultsEl.innerHTML = '';

  if (!strs.length) {
    chipsEl.style.display = 'none';
    countEl.style.display = 'none';
    checkBtn.style.display = 'none';
    toRowsBtn.style.display = 'none';
    document.getElementById('qp-clear-all-btn').style.display = 'none';
    return;
  }

  // Render chip preview
  chipsEl.style.display = 'flex';
  chipsEl.innerHTML = strs.map((s, i) => {
    const short = s.length > 24 ? s.slice(0, 24) + '…' : s;
    return `<span class="qp-chip" title="${esc(s)}" style="animation-delay:${i*.03}s">${esc(short)}</span>`;
  }).join('');

  countEl.textContent = strs.length + ' items';
  countEl.style.display = 'inline-block';
  checkBtn.style.display = 'inline-flex';
  toRowsBtn.style.display = 'inline-flex';
  document.getElementById('qp-clear-all-btn').style.display = 'inline-flex';
}

async function checkQp() {
  const strs = parseQpStr(document.getElementById('qp-input').value);
  if (!strs.length) return;

  const resultsEl = document.getElementById('qp-results');
  resultsEl.innerHTML = `<div class="empty" style="min-height:64px"><span class="spin-sm"></span><span style="color:var(--text2);font-size:13px">Đang kiểm tra ${strs.length} items...</span></div>`;

  // Parse tất cả đồng thời
  const parsed = await Promise.all(strs.map(s => parseAsync(s)));

  let html = `<div class="qp-results-wrap"><div class="qp-results-hdr">${strs.length} KẾT QUẢ</div><div class="qp-results-body">`;
  html += parsed.map(p => ric(p)).join('');
  html += '</div></div>';
  resultsEl.innerHTML = html;

  // Scroll đến kết quả
  resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function clearQp() {
  document.getElementById('qp-input').value = '';
  onQpInput('');
  document.getElementById('qp-results').innerHTML = '';
  // Ẩn manual rows card lại
  const manualCard = document.getElementById('manual-rows-card');
  manualCard.style.display = 'none';
}

function qpToRows() {
  const strs = parseQpStr(document.getElementById('qp-input').value);
  if (!strs.length) return;

  // Hiện manual rows card
  const manualCard = document.getElementById('manual-rows-card');
  manualCard.style.display = 'block';
  // Animation
  manualCard.style.opacity = '0';manualCard.style.transform = 'translateY(6px)';
  requestAnimationFrame(() => { manualCard.style.transition = 'opacity .25s,transform .25s'; manualCard.style.opacity = '1'; manualCard.style.transform = 'translateY(0)'; });

  // Fill vào manual rows
  document.getElementById('mrows').innerHTML = '';
  mrowId = 0;
  strs.forEach(s => {
    const id = mrowId++;
    const c = document.getElementById('mrows');
    const idx = c.children.length + 1;
    const wrap = document.createElement('div');
    wrap.className = 'mrow-wrap';
    wrap.id = 'mwrap' + id;
    const safeVal = s.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    wrap.innerHTML = '<div class="mrow">'
      + '<span class="mrow-num">' + idx + '</span>'
      + '<input class="field" id="mri' + id + '" value="' + safeVal + '" spellcheck="false" style="font-family:var(--mono);font-size:13px;"/>'
      + '<button class="btn bp bsm" onclick="checkOneRow(' + id + ')">Kiểm tra</button>'
      + '<button class="mrow-del" onclick="delMRow(' + id + ')" title="Xóa dòng này">&#10005;</button>'
      + '</div>'
      + '<div class="mrow-res" id="mrr' + id + '" style="display:none"></div>';
    c.appendChild(wrap);
    document.getElementById('mri' + id).addEventListener('keydown', ev => { if (ev.key === 'Enter') checkOneRow(id); });
  });
  reIndexMRows();
  // Scroll xuống manual rows
  setTimeout(() => manualCard.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
}

/* MULTI ROWS */
let mrowId=0;
function initMRows(){ /* rows added on demand */ }
function addMRow(){
  const id=mrowId++;const c=document.getElementById('mrows');const idx=c.children.length+1;
  const wrap=document.createElement('div');wrap.className='mrow-wrap';wrap.id='mwrap'+id;
  wrap.innerHTML='<div class="mrow">'
    +'<span class="mrow-num">'+idx+'</span>'
    +'<input class="field" id="mri'+id+'" placeholder="Nhập chuỗi... VD: 1935x2_50,24;14,10" spellcheck="false" style="font-family:var(--mono);font-size:13px;"/>'
    +'<button class="btn bp bsm" onclick="checkOneRow('+id+')">Kiểm tra</button>'
    +'<button class="mrow-del" onclick="delMRow('+id+')" title="Xóa dòng này">&#10005;</button>'
    +'</div>'
    +'<div class="mrow-res" id="mrr'+id+'" style="display:none"></div>';
  c.appendChild(wrap);
  document.getElementById('mri'+id).addEventListener('keydown',ev=>{if(ev.key==='Enter')checkOneRow(id);});
  reIndexMRows();
}
function delMRow(id){const el=document.getElementById('mwrap'+id);if(el)el.remove();reIndexMRows();if(document.getElementById('mrows').children.length===0)addMRow();}
function reIndexMRows(){document.querySelectorAll('#mrows .mrow-wrap').forEach((w,i)=>{const num=w.querySelector('.mrow-num');if(num)num.textContent=i+1;});}
async function checkOneRow(id){
  const inp=document.getElementById('mri'+id);const resEl=document.getElementById('mrr'+id);if(!inp||!resEl)return;
  const v=inp.value.trim();if(!v){resEl.style.display='none';return;}
  resEl.innerHTML='<div class="empty" style="min-height:50px"><span class="spin-sm"></span><span style="color:var(--text2)">Đang tra cứu...</span></div>';
  resEl.style.display='block';
  const p=await parseAsync(v);resEl.innerHTML=ric(p);
}
async function checkAllRows(){
  const wraps=[...document.querySelectorAll('#mrows .mrow-wrap')];
  await Promise.all(wraps.map(async w=>{
    const inp=w.querySelector('input.field');const resEl=w.querySelector('.mrow-res');if(!inp||!resEl)return;
    const v=inp.value.trim();if(!v){resEl.style.display='none';return;}
    resEl.innerHTML='<div class="empty" style="min-height:50px"><span class="spin-sm"></span></div>';
    resEl.style.display='block';resEl.innerHTML=ric(await parseAsync(v));
  }));
}
function clearAllRows(){document.getElementById('mrows').innerHTML='';mrowId=0;addMRow();}

/* LOOKUP ITEM */
async function lI(){
  const q=document.getElementById('li').value.trim();const el=document.getElementById('lir');if(!q)return;
  el.classList.add('on');el.innerHTML='<span class="spin-sm"></span><span style="font-size:12px;color:var(--text2)">Đang tra cứu...</span>';
  let results=[];
  if(ID[q])results=[{id:q,item:ID[q],online:false}];
  else{const ql=q.toLowerCase();results=Object.entries(ID).filter(([k,v])=>vi(v.name).toLowerCase().includes(ql)).slice(0,5).map(([k,v])=>({id:k,item:v,online:false}));}
  if(!results.length){
    const all=await fetchOnlineAll();
    if(all.length){const byId=onlineCache[String(q)];if(byId){results=[{id:String(byId.id),item:byId,online:true}];}else{const ql=q.toLowerCase();results=all.filter(o=>(o.name||'').toLowerCase().includes(ql)).slice(0,5).map(o=>({id:String(o.id),item:normalizeOnlineItem(o),online:true}));}}
  }
  if(!results.length){el.innerHTML='<span style="color:var(--red);font-size:13px">Ôi no! dữ liệu '+esc(q)+' không tìm thấy</span>';return;}
  el.innerHTML=results.map(({id,item,online})=>{
    const name=vi(item.name),desc=vi(item.description||'');const isDanh=desc==='Danh hieu'||desc==='Danh hiệu';
    const iconUrl=getIconUrl(item);const iconVal=item.icon!=null?item.icon:item.iconId;
    const onlineFb=iconVal!=null?ONLINE_ICON_BASE+iconVal+'.png':'';
    const ih=iconUrl?'<img src="'+iconUrl+'" onerror="'+(onlineFb?'this.onerror=function(){this.src=\'small/Small999999.png\'};this.src=\''+onlineFb+'\'':'this.src=\'small/Small999999.png\'')+'" style="width:38px;height:38px;object-fit:contain;border-radius:6px;background:var(--bg3);border:1px solid var(--border)">':'<img src="small/Small999999.png" style="width:38px;height:38px;object-fit:contain;border-radius:6px;background:var(--bg3);border:1px solid var(--border)">';
    const gc=gCls(item.gender);const gn=getG(item.gender);
    const idChip=`<span class="id-chip" onclick="cpId(this,'${esc(id)}')" title="Click để copy ID">ID: ${esc(id)}</span>`;
    return'<div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border);position:relative;">'
      +ih+'<div style="flex:1;min-width:0"><div style="display:flex;align-items:flex-start;justify-content:space-between;gap:6px"><div class="lr-name">'+esc(name)+'</div>'+idChip+'</div>'
      +(desc&&!isDanh?'<div style="font-size:12px;color:var(--text2);margin-top:2px">'+esc(desc)+'</div>':'')+'</div></div>'
      +'<div class="lr-row"><span class="lk">IconID</span><span class="lv">'+(iconVal!=null?iconVal:'—')+'</span><span class="lk">Type</span><span class="lv">'+(TN[item.type]||item.type)+'</span><span class="lk">Level</span><span class="lv">'+item.level+'</span></div>'
      +'<div class="lr-row" style="margin-top:5px;">'+(item.gender!==3?'<span class="tag '+gc+'">'+esc(gn)+'</span>':'')+(isDanh?'<span class="tag tp2">Banner ID: '+item.part+'</span>':(item.part>=0?'<span class="tag tgr">Part '+item.part+'</span>':''))+'</div>';
  }).join('<hr style="border-color:var(--border);margin:8px 0">');
}

/* LOOKUP OPTION */
function lO(){
  const q=document.getElementById('lo').value.trim();const el=document.getElementById('lor');if(!q)return;
  el.classList.add('on');
  let results=[];
  if(OD[q])results=[{id:q,opt:OD[q]}];
  else{const ql=q.toLowerCase();results=Object.entries(OD).filter(([k,v])=>vi(v.name).toLowerCase().includes(ql)).slice(0,5).map(([k,v])=>({id:k,opt:v}));}
  if(!results.length){el.innerHTML='<span style="color:var(--red);font-size:13px">Ôi no! dữ liệu '+esc(q)+' không tìm thấy</span>';return;}
  el.innerHTML=results.map(({id,opt})=>{const name=vi(opt.name);const hh=opt.name.includes('#');return'<div class="lr-name">'+esc(name)+'</div><div class="lr-row"><span class="lk">ID</span><span class="lv">'+esc(id)+'</span><span class="lk">Type</span><span class="lv">'+opt.type+'</span><span class="lk">Tham số</span><span class="lv" style="color:'+(hh?'var(--green)':'var(--text3)')+';">'+(hh?'Có (#)':'Không')+'</span></div>';}).join('<hr style="border-color:var(--border);margin:8px 0">');
}

/* MAP LOOKUP */
function normSearch(s){return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
function viewMap(id,name){
  const overlay=document.createElement('div');overlay.style.cssText='position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.88);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;cursor:pointer;';overlay.onclick=function(){document.body.removeChild(overlay);};
  const title=document.createElement('div');title.style.cssText='color:#fff;font-size:15px;font-weight:700;font-family:var(--sans);';title.textContent=name+' — map '+id;
  const img=document.createElement('img');img.src='https://electroheavenvn.github.io/DataNRO/TeaMobi/Maps/'+id+'.png';img.style.cssText='max-width:90vw;max-height:78vh;border-radius:10px;border:2px solid rgba(255,255,255,.15);box-shadow:0 8px 40px rgba(0,0,0,.7);';img.onerror=function(){title.textContent='Không có ảnh map '+id;};
  const hint=document.createElement('div');hint.style.cssText='color:rgba(255,255,255,.35);font-size:12px;font-family:var(--sans);';hint.textContent='Nhấn bất kỳ đâu để đóng';
  overlay.appendChild(title);overlay.appendChild(img);overlay.appendChild(hint);document.body.appendChild(overlay);
}

const SVG_COPY='<svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" style="opacity:.7;flex-shrink:0"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
const SVG_CHECK='<svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" style="flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>';

function makeBadge(mapId){
  const badge=document.createElement('span');badge.style.cssText=['align-self:flex-start','cursor:pointer','user-select:none','outline:none','-webkit-tap-highlight-color:transparent','display:inline-flex','align-items:center','gap:4px','padding:3px 10px 3px 7px','border-radius:999px','background:linear-gradient(135deg,rgba(59,139,255,.15),rgba(91,163,255,.08))','border:1px solid rgba(59,139,255,.3)','color:#5ba3ff',"font-family:'JetBrains Mono',monospace",'font-size:10.5px','font-weight:600','letter-spacing:.04em','box-shadow:0 0 8px rgba(59,139,255,.1),inset 0 1px 0 rgba(255,255,255,.04)','transition:all .2s cubic-bezier(.4,0,.2,1)'].join(';');
  badge.title='Click để copy ID';badge.innerHTML=SVG_COPY+'Map '+mapId;
  const resetBadge=()=>{badge.innerHTML=SVG_COPY+'Map '+mapId;badge.style.background='linear-gradient(135deg,rgba(59,139,255,.15),rgba(91,163,255,.08))';badge.style.borderColor='rgba(59,139,255,.3)';badge.style.color='#5ba3ff';badge.style.boxShadow='0 0 8px rgba(59,139,255,.1),inset 0 1px 0 rgba(255,255,255,.04)';};
  badge.onmouseenter=()=>{badge.style.background='linear-gradient(135deg,rgba(59,139,255,.25),rgba(91,163,255,.15))';badge.style.borderColor='rgba(59,139,255,.6)';badge.style.boxShadow='0 0 14px rgba(59,139,255,.22),0 2px 6px rgba(0,0,0,.2)';badge.style.transform='translateY(-1px)';badge.style.color='#fff';};
  badge.onmouseleave=()=>{badge.style.transform='';resetBadge();};
  badge.onclick=function(e){e.stopPropagation();navigator.clipboard.writeText(String(mapId)).then(()=>{badge.innerHTML=SVG_CHECK+'Copy ID!';badge.style.background='linear-gradient(135deg,rgba(34,197,94,.2),rgba(34,197,94,.1))';badge.style.borderColor='rgba(34,197,94,.5)';badge.style.color='#22c55e';badge.style.boxShadow='0 0 12px rgba(34,197,94,.2)';badge.style.transform='';setTimeout(resetBadge,1400);});};
  return badge;
}

function makeMapCard(m,i){
  const div=document.createElement('div');div.className='map-card';div.style.animationDelay=(i*.04)+'s';
  const thumbWrap=document.createElement('div');thumbWrap.style.cssText='width:54px;height:54px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);flex-shrink:0;overflow:hidden;';
  const thumb=document.createElement('img');thumb.src='https://electroheavenvn.github.io/DataNRO/TeaMobi/Maps/'+m.id+'_tile.png';thumb.style.cssText='width:100%;height:100%;object-fit:cover;display:block;';thumb.onerror=function(){thumbWrap.innerHTML='<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:10px;color:var(--text3);">'+m.id+'</div>';};thumbWrap.appendChild(thumb);
  const info=document.createElement('div');info.style.cssText='flex:1;min-width:0;display:flex;flex-direction:column;gap:5px;';
  const nameEl=document.createElement('span');nameEl.style.cssText=['white-space:nowrap','overflow:hidden','text-overflow:ellipsis','font-size:14px','font-weight:700','letter-spacing:.01em','background:linear-gradient(90deg,#f59e0b,#fbbf24)','-webkit-background-clip:text','-webkit-text-fill-color:transparent','background-clip:text'].join(';');nameEl.textContent=m.name;
  info.appendChild(nameEl);info.appendChild(makeBadge(m.id));
  const btn=document.createElement('button');btn.className='btn bgh bsm';btn.style.cssText='flex-shrink:0;gap:5px;display:inline-flex;align-items:center;';btn.innerHTML='<svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>Xem map';btn.onclick=function(e){e.stopPropagation();viewMap(m.id,m.name);};
  div.appendChild(thumbWrap);div.appendChild(info);div.appendChild(btn);return div;
}

function lM(){
  const q=document.getElementById('mi2').value.trim();const el=document.getElementById('mr');if(!q){el.classList.remove('on');return;}
  el.classList.add('on');const byId=MD.find(m=>String(m.id)===q);let results=[];
  if(byId)results=[byId];else{const ql=normSearch(q);results=MD.filter(m=>normSearch(m.name).includes(ql));}
  if(!results.length){el.innerHTML='<span style="color:var(--red);font-size:13px">Làm gì có Map '+esc(q)+' đâu Bro</span>';return;}
  el.innerHTML='';const hdr=document.createElement('div');hdr.style.cssText='font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--text3);margin-bottom:8px;';hdr.textContent=results.length+' KẾT QUẢ';el.appendChild(hdr);results.forEach((m,i)=>el.appendChild(makeMapCard(m,i)));
}
function clearMap(){document.getElementById('mi2').value='';const el=document.getElementById('mr');el.classList.remove('on');el.innerHTML='';}

/* BUILDER */
let brows=[],brid=0;
function abr(){brows.push({id:brid++,optId:'',val:''});rbr();uo();}
function delbr(id){brows=brows.filter(r=>r.id!==id);rbr();uo();}
function rbr(){
  const c=document.getElementById('br');
  if(!brows.length){c.innerHTML='<div style="color:var(--text3);font-size:13px;padding:6px 0">Nhấn "Thêm option" để bắt đầu</div>';return;}
  c.innerHTML=brows.map((row,i)=>{
    const od=row.optId!==''?OD[row.optId]:null;const hh=od&&od.name.includes('#');const prev=od?(hh?fo(od,row.val||'0'):vi(od.name)):'--';
    return'<div class="brow" id="br'+row.id+'">'+'<span class="bnum">'+(i+1)+'</span>'+'<select class="bsel" onchange="ubrSel('+row.id+',this.value)">'+selOpts+'</select>'+'<input class="bval" type="text" inputmode="numeric" placeholder="Giá trị" value="'+row.val+'" '+(hh?'':'disabled')+' id="bval'+row.id+'" oninput="ubrVal('+row.id+',this.value)"/>'+'<span class="bprev" id="bprev'+row.id+'">'+esc(prev)+'</span>'+'<button class="bdel" onclick="delbr('+row.id+')">×</button>'+'</div>';
  }).join('');
  brows.forEach(row=>{const s=document.querySelector('#br'+row.id+' .bsel');if(s&&row.optId!=='')s.value=row.optId;});
}
function ubrSel(id,v){const row=brows.find(r=>r.id===id);if(!row)return;row.optId=v;row.val='';rbr();uo();const s=document.querySelector('#br'+id+' .bsel');if(s)s.value=row.optId;}
function ubrVal(id,v){const row=brows.find(r=>r.id===id);if(!row)return;row.val=v;const od=row.optId!==''?OD[row.optId]:null;const hh=od&&od.name.includes('#');const prev=od?(hh?fo(od,v||'0'):vi(od.name)):'--';const prevEl=document.getElementById('bprev'+id);if(prevEl)prevEl.textContent=prev;uo();}

let uoTimer=null;
function uo(){clearTimeout(uoTimer);uoTimer=setTimeout(_uo,120);}
async function _uo(){
  const iid=document.getElementById('bid').value.trim();const qty=document.getElementById('bqty').value.trim();
  const ne=document.getElementById('bin');const qp=document.getElementById('bqtyp');const iconBox=document.getElementById('b-icon');
  if(iid){
    let item=ID[iid]||null;let online=false;if(!item){if(onlineCache[iid]){item=onlineCache[iid];online=true;}}
    if(item){ne.innerHTML='<span class="iname-b">'+esc(vi(item.name))+'</span>';const iconUrl=getIconUrl(item);if(iconUrl){iconBox.style.display='flex';iconBox.innerHTML='<img src="'+iconUrl+'" style="width:100%;height:100%;object-fit:contain;" onerror="this.parentNode.style.display=\'none\'">';}else{iconBox.style.display='none';iconBox.innerHTML='';}}
    else{ne.innerHTML='<span class="spin-sm"></span>';iconBox.style.display='none';const res=await getItemAsync(iid);if(document.getElementById('bid').value.trim()!==iid)return;if(res.item){ne.innerHTML='<span class="iname-b">'+esc(vi(res.item.name))+'</span>';const iconUrl=getIconUrl(res.item);if(iconUrl){iconBox.style.display='flex';iconBox.innerHTML='<img src="'+iconUrl+'" style="width:100%;height:100%;object-fit:contain;" onerror="this.parentNode.style.display=\'none\'">'; }}else{ne.innerHTML='<span style="font-size:12px;color:var(--red)">Không tìm thấy</span>';}}
  }else{ne.innerHTML='';iconBox.style.display='none';iconBox.innerHTML='';}
  if(qty&&parseInt(qty)>0)qp.textContent='→ Số Lượng:'+qty;else qp.textContent='';
  const valid=brows.filter(r=>r.optId!=='');
  if(!iid&&!valid.length){document.getElementById('ot').textContent='— chưa có dữ liệu —';document.getElementById('ot').style.color='var(--text3)';return;}
  const qtyStr=(qty&&parseInt(qty)>0)?'x'+qty:'';
  let str=(iid||'ITEM')+qtyStr;
  if(valid.length)str+='_'+valid.map(r=>{const hh=OD[r.optId]&&OD[r.optId].name.includes('#');return r.optId+','+(hh?(r.val||'0'):'0');}).join(';');
  document.getElementById('ot').textContent=str;document.getElementById('ot').style.color='var(--green)';
}

function cpO(){const txt=document.getElementById('ot').textContent;if(txt==='— chưa có dữ liệu —')return;navigator.clipboard.writeText(txt).then(()=>{const ob=document.getElementById('ob');ob.classList.add('cp');setTimeout(()=>ob.classList.remove('cp'),1500);});}
function toggleQty(){document.getElementById('qty-wrap').style.display='flex';document.getElementById('qty-btn').style.display='none';document.getElementById('bqty').focus();}
function removeQty(){document.getElementById('bqty').value='';document.getElementById('qty-wrap').style.display='none';document.getElementById('qty-btn').style.display='';document.getElementById('bqtyp').textContent='';uo();}
function rB(){brows=[];brid=0;document.getElementById('bid').value='';removeQty();document.getElementById('bin').innerHTML='';rbr();uo();}

document.getElementById('si').addEventListener('keydown',ev=>{if(ev.key==='Enter')checkSingle();});
document.getElementById('li').addEventListener('keydown',ev=>{if(ev.key==='Enter')lI();});
document.getElementById('lo').addEventListener('keydown',ev=>{if(ev.key==='Enter')lO();});
document.getElementById('mi2').addEventListener('keydown',ev=>{if(ev.key==='Enter')lM();});

updateBell();
initTheme();
</script>
</body>
</html>